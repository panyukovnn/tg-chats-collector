
План развития:
- превращаю в cli утилиту
- создаю стартер, который будет предоставлять апи по вызову cli
- пишу бота, который будет обращаться к cli тем самым отвечать на вопросы по моим переписка в тг

# tg-chats-collector

Позволяет извлекать историю приватных и публичных чатов в телеграм

---

### Особенности деплоя на сервер

перед первым деплоем необходимо:

- запустить микросервис и залогинится в telegram, чтобы создалась папка tdlight-session
- заполнить deploy/config.env
- выполнить deploy/init-server.sh

деплой:

- выполняется через github workflow deploy-tag

--- 

# Что требуется сделать

- Я хочу чтобы этот микросервис был максимально простым для понимания
- Что от него требуется:
  - ✅просмотр доступных чатов
  - ✅поиск информации о конкретном чате и топике
  - ✅загрузка истории чата, начиная с определенной даты

Для удобства должен быть простой UI:
- открываю ui, там видны чаты
- можно найти чат по названию (это потом)
- можно выбрать чат и нажать - загрузить историю
- можно листать историю (не обязательно)
- можно выбрать чат и нажать - проиндексировать rag, и показывается когда в последний раз проиндексирован rag
- есть окно чата с ИИ, где я могу выбрать чат с человеком и попросить по нему что-нибудь найти или сделать

В свою очередь content-conveyor (а лучше какой-то новый сервис) может:
- попросить tg-chats-collector догрузить историю за какой-то короткий срок, максимум неделю
- запрашивать сообщения из бд и все

Какие есть проблемы:
- нет тестов
- проект закрытый
- нет ui
- загружать сообщения из чата/топика, только начиная с последнего загруженного сообщения
- кеширование фактически не работает, потому что можно запросить из топика сообщения и в бд будет казаться что мы запросили их для всего чата, решение: 
  - раздельно работать с сообщениями, загруженными за чата в целом и с сообщениями, загруженными из конкретного топика, считать их разными сущностями
  - либо добавить в сообщение признак - загружено при поиске ТОЛЬКО из топика, или загружено при поиске НЕ ТОЛЬКО из топика
- плохо работает алгоритм загрузки сообщений если задать dateTo, и каждый раз загружает все сообщения, если нужны сообщения начиная с какого-то конкретного

Дополнительно:
- написать свой доменный стартер моделей
- написать свой образцовый стартер логгирования для своих же микросервисов

Подготовить план, когда я этот репозиторий выставлю на open source

## TODO

Какое API хочу у tg-chats-collector:
- выгрузка последних N сообщений (ограничение - 5000 сообщений, а зачем больше?)
    - выполняем загрузку сразу


## Сборка проекта

```shell
./gradlew quarkusBuild
```

После сборки будет создан исполняемый JAR файл: `build/tg-chats-collector-runner.jar`

## Настройка переменных окружения

Перед запуском необходимо установить переменные окружения для Telegram API, добавить рядом с jar файлом файл application-prod.properties, следующего содрежания:
```shell
TG_CLIENT_API_ID=your_api_id
TG_CLIENT_API_HASH=your_api_hash
TG_CLIENT_PHONE=your_phone_number
```

## Запуск CLI команд

Общий формат:
```shell
java -jar build/tg-chats-collector-runner.jar <команда> [опции]
```

Запуск с указанием профиля:
```shell
# Через системное свойство
java -Dquarkus.profile=localdev -jar build/tg-chats-collector-runner.jar <команда> [опции]

# Через переменную окружения
QUARKUS_PROFILE=localdev java -jar build/tg-chats-collector-runner.jar <команда> [опции]
```

Для разработки можно использовать:
```shell
./gradlew quarkusDev -Dquarkus.profile=localdev
```

## Примеры использования

### Справка

Показать список доступных команд:
```shell
java -Dquarkus.profile=prod \
     -Dquarkus.config.locations=./build/application-prod.properties \
     -Dquarkus.log.console.enable=false \
     -jar build/tg-chats-collector-runner.jar \
     --help
```

### Получить последние N чатов

```shell
cd build
java -jar tg-chats-collector-2.0.0-RC2-3-g8b75466.dirty-runner.jar \
     last-chats -c 100
```

### Поиск приватного чата

```shell
cd build
java -Dquarkus.config.locations=./application-prod.properties \
     -jar tg-chats-collector-2.0.0-RC2-runner.jar \
     search-private-chat -n "Посты"
```

### Поиск публичного канала

```shell
cd build
java -Dquarkus.config.locations=./application-prod.properties \
     -Dquarkus.log.console.enable=false \
     -jar tg-chats-collector-runner.jar \
     search-public-channel -n "@panyukovnikolay"
```

### Поиск истории чата

```shell
cd build
java -Dquarkus.config.locations=./application-prod.properties \
     -jar tg-chats-collector-2.0.0-RC2-runner.jar \
     search-history --chat-id 511555429 --from "2025-01-01T00:00:00"
```