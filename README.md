
# tg-chats-collector

Позволяет извлекать историю приватных и публичных чатов в телеграм

---

### Особенности деплоя на сервер

перед первым деплоем необходимо:

- запустить микросервис и залогинится в telegram, чтобы создалась папка tdlight-session
- заполнить deploy/config.env
- выполнить deploy/init-server.sh

деплой:

- выполняется через github workflow deploy-tag

--- 

# Что требуется сделать

- Я хочу чтобы этот микросервис был максимально простым для понимания
- Что от него требуется:
  - ✅просмотр доступных чатов
  - ✅поиск информации о конкретном чате и топике
  - ✅загрузка истории чата, начиная с определенной даты

Для удобства должен быть простой UI:
- открываю ui, там видны чаты
- можно найти чат по названию (это потом)
- можно выбрать чат и нажать - загрузить историю
- можно листать историю (не обязательно)
- можно выбрать чат и нажать - проиндексировать rag, и показывается когда в последний раз проиндексирован rag
- есть окно чата с ИИ, где я могу выбрать чат с человеком и попросить по нему что-нибудь найти или сделать

В свою очередь content-conveyor (а лучше какой-то новый сервис) может:
- попросить tg-chats-collector догрузить историю за какой-то короткий срок, максимум неделю
- запрашивать сообщения из бд и все

Какие есть проблемы:
- нет тестов
- проект закрытый
- нет ui
- загружать сообщения из чата/топика, только начиная с последнего загруженного сообщения
- кеширование фактически не работает, потому что можно запросить из топика сообщения и в бд будет казаться что мы запросили их для всего чата, решение: 
  - раздельно работать с сообщениями, загруженными за чата в целом и с сообщениями, загруженными из конкретного топика, считать их разными сущностями
  - либо добавить в сообщение признак - загружено при поиске ТОЛЬКО из топика, или загружено при поиске НЕ ТОЛЬКО из топика
- плохо работает алгоритм загрузки сообщений если задать dateTo, и каждый раз загружает все сообщения, если нужны сообщения начиная с какого-то конкретного

Дополнительно:
- написать свой доменный стартер моделей
- написать свой образцовый стартер логгирования для своих же микросервисов

Подготовить план, когда я этот репозиторий выставлю на open source

## TODO

Какое API хочу у tg-chats-collector:
- выгрузка последних N сообщений (ограничение - 5000 сообщений, а зачем больше?)
    - выполняем загрузку сразу

## Примеры использования

### Поиск публичного канала по имени

```shell
curl http://localhost:8083/tg-chats-collector/api/v1/search-public-channel-by-id -H "Content-Type: application/json" -d '{"body":{"publicChatName":"@panyukovnikolay"}}'
```

```shell
curl http://localhost:8083/tg-chats-collector/api/v1/search-private-chat -H "Content-Type: application/json" -d '{"body":{"privateChatNamePart":"Посты"}}'
```

### Поиск истории чата
```shell
curl http://localhost:8083/tg-chats-collector/api/v1/search-chat-history -H "Content-Type: application/json" -d '{"body":{"chatId":"-1001823804554","dateFrom":"2020-01-01T00:00:00"}}'
```

```shell
curl http://localhost:8083/tg-chats-collector/api/v1/search-chat-history -H "Content-Type: application/json" -d '{"body":{"chatId":"-5066383994","dateFrom":"2020-01-01T00:00:00"}}'
```